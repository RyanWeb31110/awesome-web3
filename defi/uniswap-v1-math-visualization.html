<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V1 æ•°å­¦åŸç†å¯è§†åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 36px;
        }
        
        h2 {
            color: #34495e;
            margin: 25px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        
        h3 {
            color: #34495e;
            margin: 20px 0 15px 0;
        }
        
        /* Canvasæ ·å¼ */
        .canvas-container {
            position: relative;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        label {
            font-weight: bold;
            color: #34495e;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        input[type="number"] {
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        /* ä¿¡æ¯å±•ç¤º */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .info-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .info-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .info-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* æ•°å­¦å…¬å¼ */
        .formula-box {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .math-derivation {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .math-step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
        }
        
        /* å›¾ä¾‹ */
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 3px;
        }
        
        /* è­¦å‘Šæç¤º */
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>ğŸ“Š Uniswap V1 æ’å®šä¹˜ç§¯å…¬å¼æ•°å­¦åŸç†</h1>
            
            <!-- æ ¸å¿ƒå…¬å¼ -->
            <div class="formula-box">
                x Â· y = k (æ’å®šä¹˜ç§¯å…¬å¼)
            </div>
            
            <!-- ä¸»è¦å›¾è¡¨ï¼šæ’å®šä¹˜ç§¯æ›²çº¿ -->
            <h2>1. æ’å®šä¹˜ç§¯æ›²çº¿ï¼ˆåŒæ›²çº¿ï¼‰</h2>
            <div class="canvas-container">
                <canvas id="constantProductCanvas" width="800" height="500"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>æ’å®šä¹˜ç§¯æ›²çº¿ (xÂ·y=k)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>å½“å‰çŠ¶æ€ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2ecc71;"></div>
                        <span>äº¤æ˜“è·¯å¾„</span>
                    </div>
                </div>
            </div>
            
            <!-- äº¤äº’æ§åˆ¶ -->
            <div class="controls">
                <div class="control-group">
                    <label>åˆå§‹ ETH æ•°é‡ï¼š<span id="ethValue">10</span></label>
                    <input type="range" id="ethSlider" min="5" max="20" value="10" step="0.5">
                </div>
                <div class="control-group">
                    <label>åˆå§‹ DAI æ•°é‡ï¼š<span id="daiValue">10000</span></label>
                    <input type="range" id="daiSlider" min="5000" max="20000" value="10000" step="500">
                </div>
                <div class="control-group">
                    <label>äº¤æ˜“ ETH æ•°é‡ï¼š</label>
                    <input type="number" id="tradeAmount" value="1" min="-5" max="5" step="0.1">
                </div>
                <div class="control-group">
                    <button onclick="simulateTrade()">æ¨¡æ‹Ÿäº¤æ˜“</button>
                </div>
            </div>
            
            <!-- å®æ—¶æ•°æ®å±•ç¤º -->
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">å¸¸æ•° k</div>
                    <div class="info-value" id="kValue">100,000</div>
                </div>
                <div class="info-card">
                    <div class="info-label">å½“å‰ä»·æ ¼</div>
                    <div class="info-value" id="currentPrice">1,000</div>
                    <div class="info-label">DAI/ETH</div>
                </div>
                <div class="info-card">
                    <div class="info-label">æ± ä¸­ ETH</div>
                    <div class="info-value" id="poolEth">10</div>
                </div>
                <div class="info-card">
                    <div class="info-label">æ± ä¸­ DAI</div>
                    <div class="info-value" id="poolDai">10,000</div>
                </div>
            </div>
        </div>
        
        <!-- ä»·æ ¼å‡½æ•°å›¾è¡¨ -->
        <div class="section">
            <h2>2. ä»·æ ¼å‡½æ•°æ›²çº¿</h2>
            <div class="canvas-container">
                <canvas id="priceCanvas" width="800" height="400"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9b59b6;"></div>
                        <span>ä»·æ ¼æ›²çº¿ P(x) = k/xÂ²</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e67e22;"></div>
                        <span>è¾¹é™…ä»·æ ¼</span>
                    </div>
                </div>
            </div>
            
            <div class="math-derivation">
                <h3>ä»·æ ¼æ¨å¯¼ï¼š</h3>
                <div class="math-step">
                    <strong>æ­¥éª¤1ï¼š</strong> ä»æ’å®šä¹˜ç§¯å…¬å¼å‡ºå‘<br>
                    x Â· y = k
                </div>
                <div class="math-step">
                    <strong>æ­¥éª¤2ï¼š</strong> è¡¨è¾¾yå…³äºxçš„å‡½æ•°<br>
                    y = k / x
                </div>
                <div class="math-step">
                    <strong>æ­¥éª¤3ï¼š</strong> ä»·æ ¼å®šä¹‰ï¼ˆyç›¸å¯¹äºxçš„ä»·æ ¼ï¼‰<br>
                    P = dy/dx = -k/xÂ²
                </div>
                <div class="math-step">
                    <strong>æ­¥éª¤4ï¼š</strong> ç¬æ—¶ä»·æ ¼ï¼ˆç°è´§ä»·æ ¼ï¼‰<br>
                    P_spot = y/x = k/(xÂ·x) = k/xÂ²
                </div>
            </div>
        </div>
        
        <!-- æ»‘ç‚¹åˆ†æ -->
        <div class="section">
            <h2>3. æ»‘ç‚¹åˆ†æï¼ˆPrice Impactï¼‰</h2>
            <div class="canvas-container">
                <canvas id="slippageCanvas" width="800" height="400"></canvas>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>äº¤æ˜“è§„æ¨¡ï¼ˆå æ± å­ç™¾åˆ†æ¯”ï¼‰ï¼š<span id="tradeSizePercent">10</span>%</label>
                    <input type="range" id="tradeSizeSlider" min="1" max="50" value="10">
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">æ‰§è¡Œä»·æ ¼</div>
                    <div class="info-value" id="executionPrice">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ä»·æ ¼æ»‘ç‚¹</div>
                    <div class="info-value" id="priceSlippage">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ä»·æ ¼å½±å“</div>
                    <div class="info-value" id="priceImpact">-</div>
                </div>
            </div>
        </div>
        
        <!-- æ•°å­¦æ·±åº¦è§£æ -->
        <div class="section">
            <h2>4. æ·±åº¦æ•°å­¦è§£æ</h2>
            
            <h3>4.1 æœ‰æ•ˆä»·æ ¼å…¬å¼</h3>
            <div class="math-derivation">
                <div class="math-step">
                    <strong>åœºæ™¯ï¼š</strong>ç”¨ Î”x ä¸ª Token X æ¢å– Î”y ä¸ª Token Y<br><br>
                    <strong>äº¤æ˜“å‰ï¼š</strong> xâ‚€ Â· yâ‚€ = k<br>
                    <strong>äº¤æ˜“åï¼š</strong> (xâ‚€ + Î”x) Â· (yâ‚€ - Î”y) = k<br><br>
                    <strong>æ±‚è§£ Î”yï¼š</strong><br>
                    Î”y = yâ‚€ - k/(xâ‚€ + Î”x)<br>
                    Î”y = yâ‚€ - yâ‚€Â·xâ‚€/(xâ‚€ + Î”x)<br>
                    Î”y = yâ‚€ Â· Î”x/(xâ‚€ + Î”x)<br><br>
                    <strong>æœ‰æ•ˆä»·æ ¼ï¼š</strong><br>
                    P_effective = Î”y/Î”x = yâ‚€/(xâ‚€ + Î”x)
                </div>
            </div>
            
            <h3>4.2 è€ƒè™‘æ‰‹ç»­è´¹çš„å…¬å¼</h3>
            <div class="math-derivation">
                <div class="math-step">
                    <strong>Uniswap V1 æ‰‹ç»­è´¹ï¼š</strong> 0.3%<br><br>
                    <strong>å®é™…å…¬å¼ï¼š</strong><br>
                    è¾“å…¥é‡‘é¢ï¼ˆå«è´¹ï¼‰: input_with_fee = input_amount Ã— 997<br>
                    åˆ†æ¯: denominator = reserve_in Ã— 1000 + input_with_fee<br>
                    è¾“å‡ºé‡‘é¢: output_amount = (input_with_fee Ã— reserve_out) / denominator<br><br>
                    <strong>ç®€åŒ–è¡¨ç¤ºï¼š</strong><br>
                    Î”y = 0.997 Â· Î”x Â· yâ‚€ / (xâ‚€ + 0.997 Â· Î”x)
                </div>
            </div>
            
            <h3>4.3 æ— å¸¸æŸå¤±æ¨å¯¼</h3>
            <div class="math-derivation">
                <div class="math-step">
                    <strong>å®šä¹‰ï¼š</strong><br>
                    IL = (HODLä»·å€¼ - LPä»·å€¼) / HODLä»·å€¼<br><br>
                    
                    <strong>è®¾ä»·æ ¼å˜åŒ–æ¯”ç‡ r = Pâ‚/Pâ‚€ï¼š</strong><br>
                    IL = 2âˆšr / (1 + r) - 1<br><br>
                    
                    <strong>å¸¸è§åœºæ™¯ï¼š</strong><br>
                    â€¢ ä»·æ ¼å˜åŒ– 1.5x â†’ IL â‰ˆ 2.0%<br>
                    â€¢ ä»·æ ¼å˜åŒ– 2x â†’ IL â‰ˆ 5.7%<br>
                    â€¢ ä»·æ ¼å˜åŒ– 3x â†’ IL â‰ˆ 13.4%<br>
                    â€¢ ä»·æ ¼å˜åŒ– 5x â†’ IL â‰ˆ 25.5%
                </div>
            </div>
        </div>
        
        <!-- å®é™…æ¡ˆä¾‹åˆ†æ -->
        <div class="section">
            <h2>5. å®é™…äº¤æ˜“æ¡ˆä¾‹åˆ†æ</h2>
            
            <h3>æ¡ˆä¾‹ï¼šå¤§é¢äº¤æ˜“çš„ä»·æ ¼å½±å“</h3>
            <div class="controls">
                <div class="control-group">
                    <label>æ± å­è§„æ¨¡ï¼ˆETHï¼‰ï¼š</label>
                    <input type="number" id="poolSize" value="100">
                </div>
                <div class="control-group">
                    <label>äº¤æ˜“æ•°é‡ï¼ˆETHï¼‰ï¼š</label>
                    <input type="number" id="tradeSize" value="10">
                </div>
                <div class="control-group">
                    <button onclick="calculateRealCase()">è®¡ç®—å½±å“</button>
                </div>
            </div>
            
            <div id="caseResult" class="math-derivation" style="display: none;">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- å…³é”®æ´å¯Ÿ -->
        <div class="section">
            <h2>6. å…³é”®æ´å¯Ÿä¸ç»“è®º</h2>
            
            <div class="warning">
                <h3>âš ï¸ é‡è¦è§‚å¯Ÿï¼š</h3>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>æ’å®šä¹˜ç§¯æ›²çº¿æ˜¯ä¸€æ¡åŒæ›²çº¿ï¼Œæ°¸è¿œä¸ä¼šè§¦åŠåæ ‡è½´</li>
                    <li>ä»·æ ¼æ»‘ç‚¹ä¸äº¤æ˜“è§„æ¨¡å‘ˆéçº¿æ€§å…³ç³»</li>
                    <li>å¤§é¢äº¤æ˜“çš„å®é™…ä»·æ ¼ä¼šæ˜¾è‘—åç¦»åˆå§‹æŠ¥ä»·</li>
                    <li>æµåŠ¨æ€§è¶Šæ·±ï¼Œç›¸åŒäº¤æ˜“çš„æ»‘ç‚¹è¶Šå°</li>
                </ul>
            </div>
            
            <div style="margin-top: 20px; padding: 20px; background: #e8f8f5; border-radius: 10px;">
                <h3>ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿ï¼š</h3>
                <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
                    <li><strong>ç®€å•æ€§ï¼š</strong>ä¸€ä¸ªå…¬å¼è§£å†³æ‰€æœ‰å®šä»·é—®é¢˜</li>
                    <li><strong>è¿ç»­æ€§ï¼š</strong>ä»·æ ¼è¿ç»­å˜åŒ–ï¼Œæ²¡æœ‰è·³è·ƒ</li>
                    <li><strong>è‡ªåŠ¨å¹³è¡¡ï¼š</strong>å¥—åˆ©è€…è‡ªåŠ¨ç»´æŒä»·æ ¼å‡è¡¡</li>
                    <li><strong>æ— é™æµåŠ¨æ€§ï¼š</strong>ç†è®ºä¸Šå¯ä»¥åœ¨ä»»ä½•ä»·æ ¼äº¤æ˜“ï¼ˆè™½ç„¶æ»‘ç‚¹å¯èƒ½å¾ˆå¤§ï¼‰</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let ethReserve = 10;
        let daiReserve = 10000;
        let k = ethReserve * daiReserve;
        
        // æ›´æ–°æ»‘å—æ˜¾ç¤º
        document.getElementById('ethSlider').addEventListener('input', function(e) {
            ethReserve = parseFloat(e.target.value);
            document.getElementById('ethValue').textContent = ethReserve;
            updateK();
            drawAllCharts();
        });
        
        document.getElementById('daiSlider').addEventListener('input', function(e) {
            daiReserve = parseFloat(e.target.value);
            document.getElementById('daiValue').textContent = daiReserve;
            updateK();
            drawAllCharts();
        });
        
        document.getElementById('tradeSizeSlider').addEventListener('input', function(e) {
            document.getElementById('tradeSizePercent').textContent = e.target.value;
            drawSlippageChart();
        });
        
        function updateK() {
            k = ethReserve * daiReserve;
            document.getElementById('kValue').textContent = k.toLocaleString();
            document.getElementById('currentPrice').textContent = (daiReserve / ethReserve).toFixed(2);
            document.getElementById('poolEth').textContent = ethReserve.toFixed(2);
            document.getElementById('poolDai').textContent = daiReserve.toLocaleString();
        }
        
        // ç»˜åˆ¶æ’å®šä¹˜ç§¯æ›²çº¿
        function drawConstantProductCurve() {
            const canvas = document.getElementById('constantProductCanvas');
            const ctx = canvas.getContext('2d');
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¾ç½®åæ ‡ç³»
            const padding = 60;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + height);
            ctx.lineTo(padding + width, padding + height);
            ctx.stroke();
            
            // åæ ‡è½´æ ‡ç­¾
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('ETH (x)', padding + width - 40, padding + height + 30);
            ctx.save();
            ctx.translate(20, padding + height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('DAI (y)', 0, 0);
            ctx.restore();
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxX = ethReserve * 3;
            const maxY = daiReserve * 3;
            const scaleX = width / maxX;
            const scaleY = height / maxY;
            
            // ç»˜åˆ¶åŒæ›²çº¿ x*y = k
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let x = 0.1; x <= maxX; x += 0.1) {
                const y = k / x;
                if (y <= maxY) {
                    const px = padding + x * scaleX;
                    const py = padding + height - y * scaleY;
                    
                    if (x === 0.1) {
                        ctx.moveTo(px, py);
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
            }
            ctx.stroke();
            
            // æ ‡è®°å½“å‰ç‚¹
            const currentX = padding + ethReserve * scaleX;
            const currentY = padding + height - daiReserve * scaleY;
            
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 0.5;
            ctx.setLineDash([5, 5]);
            
            // å‚ç›´ç½‘æ ¼çº¿
            for (let i = 1; i <= 10; i++) {
                const x = padding + (width * i / 10);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + height);
                ctx.stroke();
            }
            
            // æ°´å¹³ç½‘æ ¼çº¿
            for (let i = 1; i <= 10; i++) {
                const y = padding + (height * i / 10);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + width, y);
                ctx.stroke();
            }
            ctx.setLineDash([]);
            
            // æ·»åŠ æ•°å€¼æ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            
            // Xè½´æ ‡ç­¾
            for (let i = 0; i <= 5; i++) {
                const value = (maxX * i / 5).toFixed(0);
                const x = padding + (width * i / 5);
                ctx.fillText(value, x - 10, padding + height + 20);
            }
            
            // Yè½´æ ‡ç­¾
            for (let i = 0; i <= 5; i++) {
                const value = (maxY * i / 5).toFixed(0);
                const y = padding + height - (height * i / 5);
                ctx.fillText(value, padding - 45, y + 5);
            }
            
            // æ·»åŠ å…¬å¼æ ‡æ³¨
            ctx.fillStyle = '#3498db';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(`x Â· y = ${k.toLocaleString()}`, padding + width/2 - 60, padding - 20);
        }
        
        // ç»˜åˆ¶ä»·æ ¼æ›²çº¿
        function drawPriceCurve() {
            const canvas = document.getElementById('priceCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 60;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            
            // åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + height);
            ctx.lineTo(padding + width, padding + height);
            ctx.stroke();
            
            // åæ ‡è½´æ ‡ç­¾
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('ETHæ•°é‡ (x)', padding + width - 50, padding + height + 30);
            ctx.save();
            ctx.translate(20, padding + height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('ä»·æ ¼ P(x) = k/xÂ²', 0, 0);
            ctx.restore();
            
            const maxX = ethReserve * 3;
            const minX = ethReserve * 0.1;
            const scaleX = width / (maxX - minX);
            
            // è®¡ç®—ä»·æ ¼èŒƒå›´
            const maxPrice = k / (minX * minX);
            const minPrice = k / (maxX * maxX);
            const scaleY = height / (maxPrice - minPrice);
            
            // ç»˜åˆ¶ä»·æ ¼æ›²çº¿ P = k/xÂ²
            ctx.strokeStyle = '#9b59b6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let x = minX; x <= maxX; x += 0.1) {
                const price = k / (x * x);
                const px = padding + (x - minX) * scaleX;
                const py = padding + height - (price - minPrice) * scaleY;
                
                if (x === minX) {
                    ctx.moveTo(px, py);
                } else {
                    ctx.lineTo(px, py);
                }
            }
            ctx.stroke();
            
            // æ ‡è®°å½“å‰ä»·æ ¼ç‚¹
            const currentPrice = k / (ethReserve * ethReserve);
            const currentPx = padding + (ethReserve - minX) * scaleX;
            const currentPy = padding + height - (currentPrice - minPrice) * scaleY;
            
            ctx.fillStyle = '#e67e22';
            ctx.beginPath();
            ctx.arc(currentPx, currentPy, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // æ·»åŠ ä»·æ ¼æ ‡æ³¨
            ctx.fillStyle = '#e67e22';
            ctx.font = '14px Arial';
            ctx.fillText(`å½“å‰ä»·æ ¼: ${(daiReserve/ethReserve).toFixed(2)} DAI/ETH`, currentPx + 15, currentPy - 10);
        }
        
        // ç»˜åˆ¶æ»‘ç‚¹å›¾è¡¨
        function drawSlippageChart() {
            const canvas = document.getElementById('slippageCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 60;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            
            // åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + height);
            ctx.lineTo(padding + width, padding + height);
            ctx.stroke();
            
            // è·å–äº¤æ˜“è§„æ¨¡
            const tradeSizePercent = parseFloat(document.getElementById('tradeSizeSlider').value);
            const tradeAmount = ethReserve * tradeSizePercent / 100;
            
            // è®¡ç®—æ»‘ç‚¹æ•°æ®
            const steps = 50;
            const maxTrade = ethReserve * 0.5;
            const slippageData = [];
            
            for (let i = 0; i <= steps; i++) {
                const trade = (maxTrade * i) / steps;
                const newEth = ethReserve - trade;
                const newDai = k / newEth;
                const daiNeeded = newDai - daiReserve;
                
                const spotPrice = daiReserve / ethReserve;
                const executionPrice = daiNeeded / trade;
                const slippage = ((executionPrice - spotPrice) / spotPrice) * 100;
                
                slippageData.push({
                    trade: trade,
                    slippage: slippage
                });
            }
            
            // ç»˜åˆ¶æ»‘ç‚¹æ›²çº¿
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const maxSlippage = 100;
            slippageData.forEach((point, i) => {
                const x = padding + (point.trade / maxTrade) * width;
                const y = padding + height - (point.slippage / maxSlippage) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // æ ‡è®°å½“å‰äº¤æ˜“ç‚¹
            const currentNewEth = ethReserve - tradeAmount;
            const currentNewDai = k / currentNewEth;
            const currentDaiNeeded = currentNewDai - daiReserve;
            const currentSpotPrice = daiReserve / ethReserve;
            const currentExecutionPrice = currentDaiNeeded / tradeAmount;
            const currentSlippage = ((currentExecutionPrice - currentSpotPrice) / currentSpotPrice) * 100;
            
            const currentX = padding + (tradeAmount / maxTrade) * width;
            const currentY = padding + height - (currentSlippage / maxSlippage) * height;
            
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // æ›´æ–°ä¿¡æ¯å¡ç‰‡
            document.getElementById('executionPrice').textContent = currentExecutionPrice.toFixed(2);
            document.getElementById('priceSlippage').textContent = currentSlippage.toFixed(2) + '%';
            document.getElementById('priceImpact').textContent = ((currentNewDai/currentNewEth - currentSpotPrice) / currentSpotPrice * 100).toFixed(2) + '%';
            
            // æ·»åŠ æ ‡ç­¾
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('äº¤æ˜“é‡ (ETH)', padding + width - 50, padding + height + 30);
            ctx.save();
            ctx.translate(20, padding + height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('æ»‘ç‚¹ (%)', 0, 0);
            ctx.restore();
        }
        
        // æ¨¡æ‹Ÿäº¤æ˜“
        function simulateTrade() {
            const tradeAmount = parseFloat(document.getElementById('tradeAmount').value);
            
            if (tradeAmount > 0) {
                // ä¹°å…¥ETHï¼ˆå–å‡ºDAIï¼‰
                const newEth = ethReserve - tradeAmount;
                if (newEth <= 0) {
                    alert('äº¤æ˜“é‡è¿‡å¤§ï¼');
                    return;
                }
                const newDai = k / newEth;
                
                // ç»˜åˆ¶äº¤æ˜“è·¯å¾„
                const canvas = document.getElementById('constantProductCanvas');
                const ctx = canvas.getContext('2d');
                
                const padding = 60;
                const width = canvas.width - 2 * padding;
                const height = canvas.height - 2 * padding;
                const maxX = ethReserve * 3;
                const maxY = daiReserve * 3;
                const scaleX = width / maxX;
                const scaleY = height / maxY;
                
                // ç»˜åˆ¶äº¤æ˜“è·¯å¾„ï¼ˆç»¿è‰²ç®­å¤´ï¼‰
                ctx.strokeStyle = '#2ecc71';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(padding + ethReserve * scaleX, padding + height - daiReserve * scaleY);
                ctx.lineTo(padding + newEth * scaleX, padding + height - newDai * scaleY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // æ›´æ–°å‚¨å¤‡
                ethReserve = newEth;
                daiReserve = newDai;
            } else if (tradeAmount < 0) {
                // å–å‡ºETHï¼ˆä¹°å…¥DAIï¼‰
                const newEth = ethReserve - tradeAmount;
                const newDai = k / newEth;
                
                ethReserve = newEth;
                daiReserve = newDai;
            }
            
            updateK();
            setTimeout(() => drawAllCharts(), 500);
        }
        
        // è®¡ç®—å®é™…æ¡ˆä¾‹
        function calculateRealCase() {
            const poolSize = parseFloat(document.getElementById('poolSize').value);
            const tradeSize = parseFloat(document.getElementById('tradeSize').value);
            
            const poolDai = poolSize * 2000; // å‡è®¾1 ETH = 2000 DAI
            const k = poolSize * poolDai;
            
            const newEth = poolSize - tradeSize;
            const newDai = k / newEth;
            const daiNeeded = newDai - poolDai;
            
            const spotPrice = poolDai / poolSize;
            const executionPrice = daiNeeded / tradeSize;
            const slippage = ((executionPrice - spotPrice) / spotPrice) * 100;
            
            const resultDiv = document.getElementById('caseResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>è®¡ç®—ç»“æœï¼š</h3>
                <div class="math-step">
                    <strong>åˆå§‹çŠ¶æ€ï¼š</strong><br>
                    æ± ä¸­ ETH: ${poolSize}<br>
                    æ± ä¸­ DAI: ${poolDai.toLocaleString()}<br>
                    k = ${k.toLocaleString()}<br>
                    ç°è´§ä»·æ ¼: ${spotPrice.toFixed(2)} DAI/ETH
                </div>
                <div class="math-step">
                    <strong>äº¤æ˜“æ‰§è¡Œï¼š</strong><br>
                    è´­ä¹° ETH: ${tradeSize}<br>
                    äº¤æ˜“å ETH: ${newEth}<br>
                    äº¤æ˜“å DAI: ${newDai.toFixed(2)}<br>
                    éœ€è¦æ”¯ä»˜ DAI: ${daiNeeded.toFixed(2)}
                </div>
                <div class="math-step">
                    <strong>ä»·æ ¼å½±å“ï¼š</strong><br>
                    æ‰§è¡Œä»·æ ¼: ${executionPrice.toFixed(2)} DAI/ETH<br>
                    ä»·æ ¼æ»‘ç‚¹: ${slippage.toFixed(2)}%<br>
                    æ–°ç°è´§ä»·æ ¼: ${(newDai/newEth).toFixed(2)} DAI/ETH
                </div>
                <div class="math-step" style="background: #fff3cd;">
                    <strong>ğŸ’¡ æ´å¯Ÿï¼š</strong><br>
                    ${slippage > 10 ? 'âš ï¸ æ»‘ç‚¹è¿‡å¤§ï¼å»ºè®®åˆ†æ‰¹äº¤æ˜“æˆ–å¯»æ‰¾æ›´æ·±çš„æµåŠ¨æ€§æ± ã€‚' : 
                      slippage > 5 ? 'æ»‘ç‚¹é€‚ä¸­ï¼Œå¯ä»¥æ¥å—ä½†éœ€æ³¨æ„ã€‚' : 
                      'æ»‘ç‚¹è¾ƒå°ï¼Œäº¤æ˜“æ¡ä»¶è‰¯å¥½ã€‚'}
                </div>
            `;
        }
        
        // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
        function drawAllCharts() {
            drawConstantProductCurve();
            drawPriceCurve();
            drawSlippageChart();
        }
        
        // åˆå§‹åŒ–
        updateK();
        drawAllCharts();
    </script>
</body>
</html>